<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/image-picker@0.3.1/image-picker/image-picker.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/image-picker@0.3.1/image-picker/image-picker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <title>失落的龙约NGA图床/外链生成器</title>
</head>

<style type="text/css">
    div {
        margin: auto;
        padding: 5px;
    }
    
    .option-group {
        overflow-y: auto;
        position: absolute;
        top: 22%;
        bottom: 0;
    }
    
    .thumbnail {
        text-align: center;
        font-size: 12px;
    }
</style>

<body>
    <div class="button-group" id="button-group">
        <button class="btn btn-primary text-center" id="amulet-btn">护符小图</button>
        <button class="btn btn-primary text-center" id="chara-btn">角色小图</button>
        <button class="btn btn-primary text-center" id="dragon-btn">龙小图</button>
        <button class="btn btn-primary text-center" id="weapon-btn">武器小图</button>
        <button class="btn btn-success text-center" id="toggle-btn">显示/隐藏图标名称</button>
        <button class="btn btn-danger text-center" id="cancel-all-btn">取消选择</button>
        <button class="btn btn-info text-center" id="generate-link-btn">生成链接</button>
    </div>
    <div class="text-area" id="text-area">
        <textarea readonly class="output-text" id="output-text" style="width: 80%; height: 100px"> 
        </textarea>
    </div>
    <div class="option-group" id="option-group">
        <select multiple="multiple" class="icon-select" id="icon-select">
            <option></option>
        </select>
    </div>

</body>

<script>
    var icon_json;
    var toggle = false;
    var loaded = {
        'amulet': false,
        'chara': false,
        'dragon': false,
        'weapon': false
    };
    var current_type = 'rua';
    var link_text = '';
    var iconOptions = document.getElementById("icon-select");
    var outText = document.getElementById("output-text");
    var picker = $("select.icon-select").data('picker');

    fetch(`./index.json`)
        .then(function(response) {
            if (!response.ok) {
                throw Error(response.statusText);
            }
            return response;
        })
        .then(response => response.json())
        .then(json => {
            icon_json = json;
            loadOptions(icon_json);
        }).catch(function(error) {
            console.log('rua');
        });

    function loadOptions(icon_json) {
        var icon_dic = icon_json[current_type];
        $("select.icon-select").empty();
        for (var key in icon_dic) {
            var optf = document.createElement('option');
            optf.setAttribute("data-img-src", icon_dic[key]);
            optf.setAttribute("id", key);
            optf.setAttribute("value", icon_dic[key]);
            optf.innerHTML = key.split("-")[1];
            iconOptions.appendChild(optf);
        }
        toggleName();
    }

    function toggleName() {
        if (toggle) {
            $("select.icon-select").imagepicker({
                show_label: true
            });
        } else {
            $("select.icon-select").imagepicker({
                show_label: false
            });
        }
    }

    function load() {
        if (!loaded[current_type]) {
            loadOptions(icon_json);
            for (var key in loaded) {
                loaded[key] = false;
            }
            loaded[current_type] = true;
            console.log(`${current_type} loaded.`);
        }
    }

    document.getElementById("amulet-btn").addEventListener("click",
        function() {
            current_type = 'amulet';
            load();
        });
    document.getElementById("chara-btn").addEventListener("click",
        function() {
            current_type = 'chara';
            load();
        });
    document.getElementById("dragon-btn").addEventListener("click",
        function() {
            current_type = 'dragon';
            load();
        });
    document.getElementById("weapon-btn").addEventListener("click",
        function() {
            current_type = 'weapon';
            load();
        });
    document.getElementById("toggle-btn").addEventListener("click",
        function() {
            toggle = !toggle;
            toggleName();
        });
    document.getElementById("cancel-all-btn").addEventListener("click",
        function() {
            $("select.icon-select").data('picker').picker_options.forEach((imgp, i) => {
                imgp.option[0].selected = false;
            });
            $("select.icon-select").data('picker').sync_picker_with_select();
        });
    document.getElementById("generate-link-btn").addEventListener("click",
        function() {
            outText.innerHTML = "";
            $("select.icon-select").data('picker').selected_values().forEach(function(item, index) {
                outText.innerHTML += `[img]${item.replace("./","https://gitee.com/sh0wer1ee/dlicons/raw/master/")}[/img]`;
            });
        });
</script>

</html>